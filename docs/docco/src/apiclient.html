<!DOCTYPE html>

<html>
<head>
  <title>apiclient.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="apiclient.html">
                  src/apiclient.ts
                </a>
              
                
                <a class="source" href="column.html">
                  src/column.ts
                </a>
              
                
                <a class="source" href="customlogger.html">
                  src/customlogger.ts
                </a>
              
                
                <a class="source" href="index.html">
                  src/index.ts
                </a>
              
                
                <a class="source" href="logger.html">
                  src/logger.ts
                </a>
              
                
                <a class="source" href="record.html">
                  src/record.ts
                </a>
              
                
                <a class="source" href="response.html">
                  src/response.ts
                </a>
              
                
                <a class="source" href="responseparser.html">
                  src/responseparser.ts
                </a>
              
                
                <a class="source" href="responsetemplate.html">
                  src/responsetemplate.ts
                </a>
              
                
                <a class="source" href="responsetemplatemanager.html">
                  src/responsetemplatemanager.ts
                </a>
              
                
                <a class="source" href="socketconfig.html">
                  src/socketconfig.ts
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>apiclient.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> packageInfo <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;../package.json&quot;</span>;
<span class="hljs-keyword">import</span> fetch <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;node-fetch&quot;</span>;
<span class="hljs-keyword">import</span> { Logger } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./logger&quot;</span>;
<span class="hljs-keyword">import</span> { Response } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./response&quot;</span>;
<span class="hljs-keyword">import</span> { ResponseTemplateManager } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./responsetemplatemanager&quot;</span>;
<span class="hljs-keyword">import</span> { fixedURLEnc, SocketConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./socketconfig&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ISPAPI_CONNECTION_URL_PROXY = <span class="hljs-string">&quot;http://127.0.0.1/api/call.cgi&quot;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ISPAPI_CONNECTION_URL = <span class="hljs-string">&quot;https://api.ispapi.net/api/call.cgi&quot;</span>;

<span class="hljs-keyword">const</span> rtm = ResponseTemplateManager.getInstance();

<span class="hljs-comment">/**
 * APIClient class
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APIClient</span> </span>{
  <span class="hljs-comment">/**
   * API connection timeout setting
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> socketTimeout: <span class="hljs-built_in">number</span> = <span class="hljs-number">300000</span>;
  <span class="hljs-comment">/**
   * User Agent string
   */</span>
  <span class="hljs-keyword">private</span> ua: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**
   * API connection url
   */</span>
  <span class="hljs-keyword">private</span> socketURL: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**
   * Object covering API connection data
   */</span>
  <span class="hljs-keyword">private</span> socketConfig: SocketConfig;
  <span class="hljs-comment">/**
   * activity flag for debug mode
   */</span>
  <span class="hljs-keyword">private</span> debugMode: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/**
   * additional connection settings
   */</span>
  <span class="hljs-keyword">private</span> curlopts: <span class="hljs-built_in">any</span>;
  <span class="hljs-comment">/**
   * logger function for debug mode
   */</span>
  <span class="hljs-keyword">private</span> logger: Logger | <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-built_in">this</span>.ua = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-built_in">this</span>.socketURL = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-built_in">this</span>.debugMode = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">this</span>.setURL(ISPAPI_CONNECTION_URL);
    <span class="hljs-built_in">this</span>.socketConfig = <span class="hljs-keyword">new</span> SocketConfig();
    <span class="hljs-built_in">this</span>.useLIVESystem();
    <span class="hljs-built_in">this</span>.curlopts = {};
    <span class="hljs-built_in">this</span>.logger = <span class="hljs-literal">null</span>;
    <span class="hljs-built_in">this</span>.setDefaultLogger();
  }

  <span class="hljs-comment">/**
   * set custom logger to use instead of default one
   * <span class="hljs-doctag">@param <span class="hljs-variable">customLogger</span></span>
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setCustomLogger(customLogger: Logger): APIClient {
    <span class="hljs-built_in">this</span>.logger = customLogger;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }
  <span class="hljs-comment">/**
   * set default logger to use
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setDefaultLogger(): APIClient {
    <span class="hljs-built_in">this</span>.logger = <span class="hljs-keyword">new</span> Logger();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }
  <span class="hljs-comment">/**
   * Enable Debug Output to STDOUT
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> enableDebugMode(): APIClient {
    <span class="hljs-built_in">this</span>.debugMode = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Disable Debug Output
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> disableDebugMode(): APIClient {
    <span class="hljs-built_in">this</span>.debugMode = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the API Session that is currently set
   * <span class="hljs-doctag">@returns </span>API Session or null
   */</span>
  <span class="hljs-keyword">public</span> getSession(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">const</span> sessid = <span class="hljs-built_in">this</span>.socketConfig.getSession();
    <span class="hljs-keyword">return</span> sessid === <span class="hljs-string">&quot;&quot;</span> ? <span class="hljs-literal">null</span> : sessid;
  }

  <span class="hljs-comment">/**
   * Get the API connection url that is currently set
   * <span class="hljs-doctag">@returns </span>API connection url currently in use
   */</span>
  <span class="hljs-keyword">public</span> getURL(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.socketURL;
  }

  <span class="hljs-comment">/**
   * Possibility to customize default user agent to fit your needs
   * <span class="hljs-doctag">@param </span>str user agent label
   * <span class="hljs-doctag">@param </span>rv revision of user agent
   * <span class="hljs-doctag">@param </span>modules further modules to add to user agent string, format: [&quot;&lt;mod1&gt;/&lt;rev&gt;&quot;, &quot;&lt;mod2&gt;/&lt;rev&gt;&quot;, ... ]
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setUserAgent(str: <span class="hljs-built_in">string</span>, <span class="hljs-attr">rv</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">modules</span>: <span class="hljs-built_in">any</span> = []): APIClient {
    <span class="hljs-keyword">const</span> mods = modules.length ? <span class="hljs-string">&quot; &quot;</span> + modules.join(<span class="hljs-string">&quot; &quot;</span>) : <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-built_in">this</span>.ua =
      <span class="hljs-string">`<span class="hljs-subst">${str}</span> `</span> +
      <span class="hljs-string">`(<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${process.arch}</span>; rv:<span class="hljs-subst">${rv}</span>)`</span> +
      mods +
      <span class="hljs-string">` node-sdk/<span class="hljs-subst">${<span class="hljs-built_in">this</span>.getVersion()}</span> `</span> +
      <span class="hljs-string">`node/<span class="hljs-subst">${process.version}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the User Agent
   * <span class="hljs-doctag">@returns </span>User Agent string
   */</span>
  <span class="hljs-keyword">public</span> getUserAgent(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.ua.length) {
      <span class="hljs-built_in">this</span>.ua =
        <span class="hljs-string">`NODE-SDK (<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${
          process.arch
        }</span>; rv:<span class="hljs-subst">${<span class="hljs-built_in">this</span>.getVersion()}</span>) `</span> + <span class="hljs-string">`node/<span class="hljs-subst">${process.version}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.ua;
  }

  <span class="hljs-comment">/**
   * Set the proxy server to use for API communication
   * <span class="hljs-doctag">@param </span>proxy proxy server to use for communicatio
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setProxy(proxy: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.curlopts.proxy = proxy;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the proxy server configuration
   * <span class="hljs-doctag">@returns </span>proxy server configuration value or null if not set
   */</span>
  <span class="hljs-keyword">public</span> getProxy(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(<span class="hljs-built_in">this</span>.curlopts, <span class="hljs-string">&quot;proxy&quot;</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.curlopts.proxy;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">/**
   * Set the referer to use for API communication
   * <span class="hljs-doctag">@param </span>referer Referer
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setReferer(referer: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.curlopts.referer = referer;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the referer configuration
   * <span class="hljs-doctag">@returns </span>referer configuration value or null if not set
   */</span>
  <span class="hljs-keyword">public</span> getReferer(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(<span class="hljs-built_in">this</span>.curlopts, <span class="hljs-string">&quot;referer&quot;</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.curlopts.referer;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">/**
   * Get the current module version
   * <span class="hljs-doctag">@returns </span>module version
   */</span>
  <span class="hljs-keyword">public</span> getVersion(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> packageInfo.version;
  }

  <span class="hljs-comment">/**
   * Apply session data (session id and system entity) to given client request session
   * <span class="hljs-doctag">@param </span>session ClientRequest session instance
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> saveSession(session: <span class="hljs-built_in">any</span>): APIClient {
    session.socketcfg = {
      <span class="hljs-attr">entity</span>: <span class="hljs-built_in">this</span>.socketConfig.getSystemEntity(),
      <span class="hljs-attr">session</span>: <span class="hljs-built_in">this</span>.socketConfig.getSession(),
    };
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Use existing configuration out of ClientRequest session
   * to rebuild and reuse connection settings
   * <span class="hljs-doctag">@param </span>session ClientRequest session instance
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> reuseSession(session: <span class="hljs-built_in">any</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setSystemEntity(session.socketcfg.entity);
    <span class="hljs-built_in">this</span>.setSession(session.socketcfg.session);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set another connection url to be used for API communication
   * <span class="hljs-doctag">@param </span>value API connection url to set
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setURL(value: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketURL = value;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set one time password to be used for API communication
   * <span class="hljs-doctag">@param </span>value one time password
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setOTP(value: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setOTP(value);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set an API session id to be used for API communication
   * <span class="hljs-doctag">@param </span>value API session id
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setSession(value: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setSession(value);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set an Remote IP Address to be used for API communication
   * To be used in case you have an active ip filter setting.
   * <span class="hljs-doctag">@param </span>value Remote IP Address
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setRemoteIPAddress(value: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setRemoteAddress(value);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set Credentials to be used for API communication
   * <span class="hljs-doctag">@param </span>uid account name
   * <span class="hljs-doctag">@param </span>pw account password
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setCredentials(uid: <span class="hljs-built_in">string</span>, <span class="hljs-attr">pw</span>: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setLogin(uid);
    <span class="hljs-built_in">this</span>.socketConfig.setPassword(pw);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set Credentials to be used for API communication
   * <span class="hljs-doctag">@param </span>uid account name
   * <span class="hljs-doctag">@param </span>role role user id
   * <span class="hljs-doctag">@param </span>pw role user password
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setRoleCredentials(uid: <span class="hljs-built_in">string</span>, <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">pw</span>: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.setCredentials(role ? <span class="hljs-string">`<span class="hljs-subst">${uid}</span>!<span class="hljs-subst">${role}</span>`</span> : uid, pw);
  }

  <span class="hljs-comment">/**
   * Perform API login to start session-based communication
   * <span class="hljs-doctag">@param </span>otp optional one time password
   * <span class="hljs-doctag">@returns </span>Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> login(otp = <span class="hljs-string">&quot;&quot;</span>): <span class="hljs-built_in">Promise</span>&lt;Response&gt; {
    <span class="hljs-built_in">this</span>.setOTP(otp || <span class="hljs-string">&quot;&quot;</span>);
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.request({ <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StartSession&quot;</span> });
    <span class="hljs-keyword">if</span> (rr.isSuccess()) {
      <span class="hljs-keyword">const</span> col = rr.getColumn(<span class="hljs-string">&quot;SESSION&quot;</span>);
      <span class="hljs-built_in">this</span>.setSession(col ? col.getData()[<span class="hljs-number">0</span>] : <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API login to start session-based communication.
   * Use given specific command parameters.
   * <span class="hljs-doctag">@param </span>params given specific command parameters
   * <span class="hljs-doctag">@param </span>otp optional one time password
   * <span class="hljs-doctag">@returns </span>Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> loginExtended(params: <span class="hljs-built_in">any</span>, otp = <span class="hljs-string">&quot;&quot;</span>): <span class="hljs-built_in">Promise</span>&lt;Response&gt; {
    <span class="hljs-built_in">this</span>.setOTP(otp);
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.request(
      <span class="hljs-built_in">Object</span>.assign(
        {
          <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StartSession&quot;</span>,
        },
        params
      )
    );
    <span class="hljs-keyword">if</span> (rr.isSuccess()) {
      <span class="hljs-keyword">const</span> col = rr.getColumn(<span class="hljs-string">&quot;SESSION&quot;</span>);
      <span class="hljs-built_in">this</span>.setSession(col ? col.getData()[<span class="hljs-number">0</span>] : <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API logout to close API session in use
   * <span class="hljs-doctag">@returns </span>Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> logout(): <span class="hljs-built_in">Promise</span>&lt;Response&gt; {
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.request({
      <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;EndSession&quot;</span>,
    });
    <span class="hljs-keyword">if</span> (rr.isSuccess()) {
      <span class="hljs-built_in">this</span>.setSession(<span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API request using the given command
   * <span class="hljs-doctag">@param </span>cmd API command to request
   * <span class="hljs-doctag">@returns </span>Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> request(cmd: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">Promise</span>&lt;Response&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>flatten nested api command bulk parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> mycmd = <span class="hljs-built_in">this</span>.flattenCommand(cmd);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>auto convert umlaut names to punycode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mycmd = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.autoIDNConvert(mycmd);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>request command to API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> cfg: <span class="hljs-built_in">any</span> = {
      <span class="hljs-attr">CONNECTION_URL</span>: <span class="hljs-built_in">this</span>.socketURL,
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>TODO: 300s (to be sure to get an API response)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> reqCfg: <span class="hljs-built_in">any</span> = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>encoding: “utf8”, //default for type string
gzip: true,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      body: <span class="hljs-built_in">this</span>.getPOSTData(mycmd),
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-built_in">this</span>.getUserAgent(),
      },
      <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,
      <span class="hljs-attr">timeout</span>: APIClient.socketTimeout,
      <span class="hljs-attr">url</span>: cfg.CONNECTION_URL,
    };
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-built_in">this</span>.getProxy();
    <span class="hljs-keyword">if</span> (proxy) {
      reqCfg.proxy = proxy;
    }
    <span class="hljs-keyword">const</span> referer = <span class="hljs-built_in">this</span>.getReferer();
    <span class="hljs-keyword">if</span> (referer) {
      reqCfg.headers.Referer = referer;
    }
    <span class="hljs-keyword">return</span> fetch(cfg.CONNECTION_URL, reqCfg)
      .then(<span class="hljs-keyword">async</span> (res: <span class="hljs-built_in">any</span>) =&gt; {
        <span class="hljs-keyword">let</span> error = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">let</span> body;
        <span class="hljs-keyword">if</span> (res.ok) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>res.status &gt;= 200 &amp;&amp; res.status &lt; 300</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          body = <span class="hljs-keyword">await</span> res.text();
        } <span class="hljs-keyword">else</span> {
          error = res.status + (res.statusText ? <span class="hljs-string">&quot; &quot;</span> + res.statusText : <span class="hljs-string">&quot;&quot;</span>);
          body = rtm.getTemplate(<span class="hljs-string">&quot;httperror&quot;</span>).getPlain();
        }
        <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">new</span> Response(body, mycmd, cfg);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.debugMode &amp;&amp; <span class="hljs-built_in">this</span>.logger) {
          <span class="hljs-built_in">this</span>.logger.log(<span class="hljs-built_in">this</span>.getPOSTData(mycmd, <span class="hljs-literal">true</span>), rr, error);
        }
        <span class="hljs-keyword">return</span> rr;
      })
      .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> body = rtm.getTemplate(<span class="hljs-string">&quot;httperror&quot;</span>).getPlain();
        <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">new</span> Response(body, mycmd, cfg);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.debugMode &amp;&amp; <span class="hljs-built_in">this</span>.logger) {
          <span class="hljs-built_in">this</span>.logger.log(<span class="hljs-built_in">this</span>.getPOSTData(mycmd, <span class="hljs-literal">true</span>), rr, err.message);
        }
        <span class="hljs-keyword">return</span> err;
      });
  }

  <span class="hljs-comment">/**
   * Request the next page of list entries for the current list query
   * Useful for tables
   * <span class="hljs-doctag">@param </span>rr API Response of current page
   * <span class="hljs-doctag">@returns </span>Promise resolving with API Response or null in case there are no further list entries
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> requestNextResponsePage(rr: Response): <span class="hljs-built_in">Promise</span>&lt;Response | <span class="hljs-literal">null</span>&gt; {
    <span class="hljs-keyword">const</span> mycmd = rr.getCommand();
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(mycmd, <span class="hljs-string">&quot;LAST&quot;</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">&quot;Parameter LAST in use. Please remove it to avoid issues in requestNextPage.&quot;</span>
      );
    }
    <span class="hljs-keyword">let</span> first = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(mycmd, <span class="hljs-string">&quot;FIRST&quot;</span>)) {
      first = mycmd.FIRST;
    }
    <span class="hljs-keyword">const</span> total = rr.getRecordsTotalCount();
    <span class="hljs-keyword">const</span> limit = rr.getRecordsLimitation();
    first += limit;
    <span class="hljs-keyword">if</span> (first &lt; total) {
      mycmd.FIRST = first;
      mycmd.LIMIT = limit;
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request(mycmd);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  }

  <span class="hljs-comment">/**
   * Request all pages/entries for the given query command
   * <span class="hljs-doctag">@param </span>cmd API list command to use
   * <span class="hljs-doctag">@returns </span>Promise resolving with array of API Responses
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> requestAllResponsePages(cmd: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">Promise</span>&lt;Response[]&gt; {
    <span class="hljs-keyword">const</span> responses: Response[] = [];
    <span class="hljs-keyword">const</span> rr: Response = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.request(
      <span class="hljs-built_in">Object</span>.assign({}, cmd, { <span class="hljs-attr">FIRST</span>: <span class="hljs-number">0</span> })
    );
    <span class="hljs-keyword">let</span> tmp: Response | <span class="hljs-literal">null</span> = rr;
    <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
      responses[idx++] = tmp;
      tmp = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.requestNextResponsePage(tmp);
    } <span class="hljs-keyword">while</span> (tmp !== <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">return</span> responses;
  }

  <span class="hljs-comment">/**
   * Set a data view to a given subuser
   * <span class="hljs-doctag">@param </span>uid subuser account name
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> setUserView(uid: <span class="hljs-built_in">string</span>): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setUser(uid);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Reset data view back from subuser to user
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> resetUserView(): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setUser(<span class="hljs-string">&quot;&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Activate High Performance Connection Setup
   * <span class="hljs-doctag">@see </span>https://github.com/hexonet/node-sdk/blob/master/README.md
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> useHighPerformanceConnectionSetup(): APIClient {
    <span class="hljs-built_in">this</span>.setURL(ISPAPI_CONNECTION_URL_PROXY);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Activate Default Connection Setup (the default)
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> useDefaultConnectionSetup(): APIClient {
    <span class="hljs-built_in">this</span>.setURL(ISPAPI_CONNECTION_URL);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set OT&amp;E System for API communication
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> useOTESystem(): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setSystemEntity(<span class="hljs-string">&quot;1234&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Set LIVE System for API communication (this is the default setting)
   * <span class="hljs-doctag">@returns </span>Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> useLIVESystem(): APIClient {
    <span class="hljs-built_in">this</span>.socketConfig.setSystemEntity(<span class="hljs-string">&quot;54cd&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
  }

  <span class="hljs-comment">/**
   * Serialize given command for POST request including connection configuration data
   * <span class="hljs-doctag">@param </span>cmd API command to encode
   * <span class="hljs-doctag">@returns </span>encoded POST data string
   */</span>
  <span class="hljs-keyword">public</span> getPOSTData(cmd: <span class="hljs-built_in">any</span>, secured = <span class="hljs-literal">false</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">this</span>.socketConfig.getPOSTData();
    <span class="hljs-keyword">if</span> (secured) {
      data = data.replace(<span class="hljs-regexp">/s_pw=[^&amp;]+/</span>, <span class="hljs-string">&quot;s_pw=***&quot;</span>);
    }

    <span class="hljs-keyword">let</span> tmp = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&quot;string&quot;</span> || cmd <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span>)) {
      <span class="hljs-built_in">Object</span>.keys(cmd).forEach(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (cmd[key] !== <span class="hljs-literal">null</span> &amp;&amp; cmd[key] !== <span class="hljs-literal">undefined</span>) {
          tmp += <span class="hljs-string">`<span class="hljs-subst">${key}</span>=<span class="hljs-subst">${cmd[key].toString().replace(<span class="hljs-regexp">/\r|\n/g</span>, <span class="hljs-string">&quot;&quot;</span>)}</span>\n`</span>;
        }
      });
    } <span class="hljs-keyword">else</span> {
      tmp = <span class="hljs-string">&quot;&quot;</span> + cmd;
    }
    <span class="hljs-keyword">if</span> (secured) {
      tmp = tmp.replace(<span class="hljs-regexp">/PASSWORD=[^\n]+/</span>, <span class="hljs-string">&quot;PASSWORD=***&quot;</span>);
    }
    tmp = tmp.replace(<span class="hljs-regexp">/\n$/</span>, <span class="hljs-string">&quot;&quot;</span>);
    data += <span class="hljs-string">`<span class="hljs-subst">${fixedURLEnc(<span class="hljs-string">&quot;s_command&quot;</span>)}</span>=<span class="hljs-subst">${fixedURLEnc(tmp)}</span>`</span>;
    <span class="hljs-keyword">return</span> data;
  }

  <span class="hljs-comment">/**
   * Flatten nested arrays in command
   * <span class="hljs-doctag">@param </span>cmd api command
   * <span class="hljs-doctag">@returns </span>api command with flattended parameters
   */</span>
  <span class="hljs-keyword">private</span> flattenCommand(cmd: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">const</span> newcmd: <span class="hljs-built_in">any</span> = {};
    <span class="hljs-built_in">Object</span>.keys(cmd).forEach(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> val = cmd[key];
      <span class="hljs-keyword">const</span> newKey = key.toUpperCase();
      <span class="hljs-keyword">if</span> (val !== <span class="hljs-literal">null</span> &amp;&amp; val !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(val)) {
          <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> row <span class="hljs-keyword">of</span> val) {
            newcmd[<span class="hljs-string">`<span class="hljs-subst">${newKey}</span><span class="hljs-subst">${index}</span>`</span>] = (row + <span class="hljs-string">&quot;&quot;</span>).replace(<span class="hljs-regexp">/\r|\n/g</span>, <span class="hljs-string">&quot;&quot;</span>);
            index++;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">&quot;string&quot;</span> || val <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span>) {
            newcmd[newKey] = val.replace(<span class="hljs-regexp">/\r|\n/g</span>, <span class="hljs-string">&quot;&quot;</span>);
          } <span class="hljs-keyword">else</span> {
            newcmd[newKey] = val;
          }
        }
      }
    });
    <span class="hljs-keyword">return</span> newcmd;
  }

  <span class="hljs-comment">/**
   * Auto convert API command parameters to punycode, if necessary.
   * <span class="hljs-doctag">@param </span>cmd api command
   * <span class="hljs-doctag">@returns </span>Promise resolving with api command with IDN values replaced to punycode
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> autoIDNConvert(cmd: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>don’t convert for convertidn command to avoid endless loop
and ignore commands in string format (even deprecated)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (
      <span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&quot;string&quot;</span> ||
      cmd <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span> ||
      <span class="hljs-regexp">/^CONVERTIDN$/i</span>.test(cmd.COMMAND)
    ) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">Object</span>.keys(cmd).filter(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^(DOMAIN|NAMESERVER|DNSZONE)([0-9]*)$/i</span>.test(key);
    });
    <span class="hljs-keyword">if</span> (!keys.length) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> toconvert: <span class="hljs-built_in">any</span> = [];
    <span class="hljs-keyword">const</span> idxs: <span class="hljs-built_in">string</span>[] = [];
    keys.forEach(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (
        cmd[key] !== <span class="hljs-literal">null</span> &amp;&amp;
        cmd[key] !== <span class="hljs-literal">undefined</span> &amp;&amp;
        <span class="hljs-regexp">/[^a-z0-9.\- ]/i</span>.test(cmd[key])
      ) {
        toconvert.push(cmd[key]);
        idxs.push(key);
      }
    });

    <span class="hljs-keyword">if</span> (!toconvert.length) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.request({
      <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;ConvertIDN&quot;</span>,
      <span class="hljs-attr">DOMAIN</span>: toconvert,
    });
    <span class="hljs-built_in">console</span>.dir(r.getPlain());
    <span class="hljs-keyword">if</span> (r.isSuccess()) {
      <span class="hljs-keyword">const</span> col = r.getColumn(<span class="hljs-string">&quot;ACE&quot;</span>);
      <span class="hljs-keyword">if</span> (col) {
        col.getData().forEach(<span class="hljs-function">(<span class="hljs-params">pc: <span class="hljs-built_in">string</span>, idx: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          cmd[idxs[idx]] = pc;
        });
      }
    }
    <span class="hljs-keyword">return</span> cmd;
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
